cp /u2/tmp/mod_tile_build/src/renderd .
cp /u2/tmp/mod_tile_build/src/render_expired .
cp /u2/tmp/mod_tile_build/src/render_list .
cp /u2/tmp/mod_tile_build/src/render_speedtest .
cp /u2/tmp/mod_tile_build/src/mod_tile.so .
docker build -t testimage .
#0 building with "default" instance using docker driver

#1 [internal] load build definition from Dockerfile
#1 transferring dockerfile: 7.20kB done
#1 DONE 0.0s

#2 [internal] load metadata for docker.io/library/ubuntu:22.04
#2 DONE 0.5s

#3 [internal] load .dockerignore
#3 transferring context: 113B done
#3 DONE 0.0s

#4 [compiler-common 1/2] FROM docker.io/library/ubuntu:22.04@sha256:77906da86b60585ce12215807090eb327e7386c8fafb5402369e421f44eff17e
#4 DONE 0.0s

#5 [internal] load build context
#5 transferring context: 519.92kB done
#5 DONE 0.0s

#6 [final  4/29] RUN wget https://github.com/googlefonts/noto-emoji/blob/9a5261d871451f9b5183c93483cbd68ed916b1e9/fonts/NotoEmoji-Regular.ttf?raw=true --content-disposition -P /usr/share/fonts/
#6 CACHED

#7 [final 18/29] COPY postgresql.custom.conf.tmpl /etc/postgresql/15/main/
#7 CACHED

#8 [final 22/29] COPY --from=compiler-helper-script /home/renderer/src/regional /home/renderer/src/regional
#8 CACHED

#9 [final 20/29] RUN mkdir -p /run/renderd/   &&  mkdir  -p  /data/database/    &&  mkdir  -p  /data/style/    &&  mkdir  -p  /home/renderer/src/    &&  chown  -R  renderer:  /data/    &&  chown  -R  renderer:  /home/renderer/src/    &&  chown  -R  renderer:  /run/renderd    &&  mv  /var/lib/postgresql/15/main/  /data/database/postgres/    &&  mv  /var/cache/renderd/tiles/            /data/tiles/       &&  chown  -R  renderer: /data/tiles   &&  ln  -s  /data/database/postgres  /var/lib/postgresql/15/main               &&  ln  -s  /data/style              /home/renderer/src/openstreetmap-carto    &&  ln  -s  /data/tiles              /var/cache/renderd/tiles                  ;
#9 CACHED

#10 [final 13/29] COPY leaflet-demo.html /var/www/html/index.html
#10 CACHED

#11 [final 27/29] COPY render_speedtest /usr/bin/render_speedtest
#11 CACHED

#12 [final  3/29] RUN adduser --disabled-password --gecos "" renderer
#12 CACHED

#13 [compiler-common 2/2] RUN apt-get update   && apt-get install -y --no-install-recommends   ca-certificates gnupg lsb-release locales   wget curl   git-core unzip unrar   && locale-gen C.UTF-8 && update-locale LANG=C.UTF-8   && sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'   && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -   && apt-get update && apt-get -y upgrade
#13 CACHED

#14 [final 26/29] COPY render_list /usr/bin/render_list
#14 CACHED

#15 [final 14/29] RUN cd /var/www/html/   && wget https://github.com/Leaflet/Leaflet/releases/download/v1.8.0/leaflet.zip   && unzip leaflet.zip   && rm leaflet.zip
#15 CACHED

#16 [final 17/29] RUN chmod +x /usr/bin/openstreetmap-tiles-update-expire.sh   && mkdir /var/log/tiles   && chmod a+rw /var/log/tiles   && ln -s /home/renderer/src/mod_tile/osmosis-db_replag /usr/bin/osmosis-db_replag   && echo "* * * * *   renderer    openstreetmap-tiles-update-expire.sh\n" >> /etc/crontab
#16 CACHED

#17 [final  2/29] RUN apt-get update   && apt-get install -y --no-install-recommends   apache2   cron   dateutils   fonts-hanazono   fonts-noto-core   fonts-noto-cjk   fonts-noto-color-emoji   fonts-noto-hinted   fonts-noto-unhinted   fonts-unifont   gnupg2   gdal-bin   liblua5.3-dev   lua5.3   mapnik-utils   npm   osm2pgsql   osmium-tool   osmosis   postgresql-15   postgresql-15-postgis-3   postgresql-15-postgis-3-scripts   postgis   python-is-python3   python3-mapnik   python3-lxml   python3-psycopg2   python3-shapely   python3-pip   libmemcached-dev   renderd   libapache2-mod-tile   librados2   file   sudo   vim   python3-certbot-dns-cloudflare   && apt-get clean autoclean   && apt-get autoremove --yes   && rm -rf /var/lib/{apt,dpkg,cache,log}/
#17 CACHED

#18 [final 25/29] COPY render_expired /usr/bin/render_expired
#18 CACHED

#19 [final  7/29] RUN wget https://github.com/stamen/terrain-classic/blob/master/fonts/unifont-Medium.ttf?raw=true --content-disposition -P /usr/share/fonts/
#19 CACHED

#20 [final 21/29] RUN echo '[default] \n  HOST=localhost \n  URI=/tile/ \n  TILEDIR=/var/cache/renderd/tiles \n  XML=/home/renderer/src/openstreetmap-carto/mapnik.xml \n  TILESIZE=256 \n  MAXZOOM=20' >> /etc/renderd.conf   && sed -i 's,/usr/share/fonts/truetype,/usr/share/fonts,g' /etc/renderd.conf
#20 CACHED

#21 [final  9/29] RUN npm install -g carto
#21 CACHED

#22 [final  5/29] COPY NotoEmoji-Bold.ttf /usr/share/fonts/NotoEmoji-Bold.ttf
#22 CACHED

#23 [final 11/29] COPY apache.conf /etc/apache2/sites-available/000-default.conf
#23 CACHED

#24 [final 12/29] RUN a2enmod ssl
#24 CACHED

#25 [final 19/29] RUN chown -R postgres:postgres /var/lib/postgresql   && chown postgres:postgres /etc/postgresql/15/main/postgresql.custom.conf.tmpl   && echo "host all all 0.0.0.0/0 scram-sha-256" >> /etc/postgresql/15/main/pg_hba.conf   && echo "host all all ::/0 scram-sha-256" >> /etc/postgresql/15/main/pg_hba.conf
#25 CACHED

#26 [final 10/29] RUN echo "LoadModule tile_module /usr/lib/apache2/modules/mod_tile.so" >> /etc/apache2/conf-available/mod_tile.conf   && echo "LoadModule headers_module /usr/lib/apache2/modules/mod_headers.so" >> /etc/apache2/conf-available/mod_headers.conf   && a2enconf mod_tile && a2enconf mod_headers
#26 CACHED

#27 [compiler-helper-script 1/1] RUN mkdir -p /home/renderer/src   && cd /home/renderer/src   && git clone https://github.com/zverik/regional   && cd regional   && rm -rf .git   && chmod u+x /home/renderer/src/regional/trim_osc.py
#27 CACHED

#28 [final  1/29] RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
#28 CACHED

#29 [final  8/29] RUN pip3 install   requests   osmium   pyyaml
#29 CACHED

#30 [final  6/29] COPY NotoSansSyriac-Black.ttf /usr/share/fonts/NotoSansSyriac-Black.ttf
#30 CACHED

#31 [final 28/29] COPY mod_tile.so /usr/lib/apache2/modules/mod_tile.so
#31 CACHED

#32 [final 24/29] COPY renderd /usr/bin/renderd
#32 CACHED

#33 [compiler-stylesheet 1/1] RUN cd ~   && git clone --single-branch --branch master https://github.com/gravitystorm/openstreetmap-carto.git --depth 1   && cd openstreetmap-carto   && sed -i 's/, "unifont Medium", "Unifont Upper Medium"//g' style/fonts.mss   && sed -i 's/"Noto Sans Tibetan Regular",//g' style/fonts.mss   && sed -i 's/"Noto Sans Tibetan Bold",//g' style/fonts.mss   && sed -i 's/Noto Sans Syriac Eastern Regular/Noto Sans Syriac Regular/g' style/fonts.mss   && rm -rf .git
#33 CACHED

#34 [final 23/29] COPY --from=compiler-stylesheet /root/openstreetmap-carto /home/renderer/src/openstreetmap-carto-backup
#34 CACHED

#35 [final 16/29] COPY openstreetmap-tiles-update-expire.sh /usr/bin/
#35 CACHED

#36 [final 15/29] RUN wget -O /var/www/html/favicon.ico https://www.openstreetmap.org/favicon.ico
#36 CACHED

#37 [final 29/29] COPY run.sh /
#37 CACHED

#38 exporting to image
#38 exporting layers done
#38 writing image sha256:0c3c34f7478e83a5a09ba6724ff38a557a4fb23ca4c1c4d76f2cd334bebca8a7 done
#38 naming to docker.io/library/testimage done
#38 DONE 0.0s
